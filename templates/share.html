{% extends "base.html" %}
{% block body %}
<div class="card" id="mainContainer">
  <h1>Shared Files</h1>
  {% if files %}
    <p>You have shared {{ files|length }} file(s). Select a destination and click Save, or clear the list.</p>
    <div id="shareFileList">
      {% for file in files %}
        <div class="card">{{ file.name }}</div>
      {% endfor %}
    </div>
    <p><b>Select destination folder:</b></p>
    <div id="folderTree" style="height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: .5rem; border-radius: .5rem; background: var(--bg-primary); margin-bottom: 1rem;">Loading...</div>
    <div style="display: flex; gap: 0.5rem;">
        <button class="btn btn-primary" id="confirmShareBtn" disabled><i class="fas fa-save"></i> Save All Files</button>
        <button class="btn btn-danger" id="clearShareBtn"><i class="fas fa-trash"></i> Clear All</button>
    </div>
  {% else %}
    <p>No pending files to share. You can close this page.</p>
  {% endif %}
</div>

<script>
  // Simplified script for this page
  let selectedShareDestination = '';
  const file_ids = {{ files|map(attribute='id')|list|tojson }};

  function renderFolderTree(nodes, level = 0) {
      let html = '';
      for (const node of nodes) {
          html += `<div class="folder-tree-item" data-path="${node.path}" style="padding-left: ${level * 20}px;"><i class="fas fa-folder"></i> ${node.name}</div>`;
          if (node.children && node.children.length > 0) {
              html += renderFolderTree(node.children, level + 1);
          }
      }
      return html;
  }

  async function loadFolderTree() {
      const folderTreeDiv = document.getElementById('folderTree');
      try {
          const response = await fetch('/api/folders');
          const data = await response.json();
          if (data.ok) {
              folderTreeDiv.innerHTML = renderFolderTree(data.tree);
              document.querySelectorAll('#folderTree .folder-tree-item').forEach(item => {
                  item.addEventListener('click', (e) => {
                      e.stopPropagation();
                      document.querySelectorAll('#folderTree .folder-tree-item').forEach(i => i.classList.remove('selected'));
                      item.classList.add('selected');
                      selectedShareDestination = item.dataset.path;
                      document.getElementById('confirmShareBtn').disabled = false;
                  });
              });
          } else {
              folderTreeDiv.innerHTML = `Error: ${data.error || 'Could not load folders.'}`;
          }
      } catch (error) {
          folderTreeDiv.innerHTML = 'Error loading folders.';
      }
  }

  async function confirmShare() {
      if (file_ids.length === 0 || selectedShareDestination === '') {
          showToast('Please select a destination folder.', 'error');
          return;
      }
      document.getElementById('confirmShareBtn').disabled = true;
      document.getElementById('confirmShareBtn').innerHTML = 'Saving...';

      try {
          const r = await fetch('/api/commit_share', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ids: file_ids, destination: selectedShareDestination })
          });
          const j = await r.json();
          if (j.ok) {
              document.getElementById('mainContainer').innerHTML = '<h1>Share Complete!</h1><p>' + j.committed.length + ' file(s) saved successfully.</p><a href="/" class="btn btn-primary">Back to App</a>';
          } else {
              showToast(j.error || 'Share failed.', 'error');
              document.getElementById('confirmShareBtn').disabled = false;
              document.getElementById('confirmShareBtn').innerHTML = '<i class="fas fa-save"></i> Save All Files';
          }
      } catch (e) {
          showToast('An error occurred during the share.', 'error');
          document.getElementById('confirmShareBtn').disabled = false;
          document.getElementById('confirmShareBtn').innerHTML = '<i class="fas fa-save"></i> Save All Files';
      }
  }

  async function clearShareList() {
      if (!confirm('Are you sure you want to clear all shared files? This cannot be undone.')) {
        return;
      }

      try {
          const r = await fetch('/api/clear_shares', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
          });
          const j = await r.json();
          if (j.ok) {
              document.getElementById('mainContainer').innerHTML = '<h1>List Cleared</h1><p>' + j.deleted_count + ' file(s) have been removed.</p><a href="/" class="btn btn-primary">Back to App</a>';
          } else {
              showToast(j.error || 'Failed to clear list.', 'error');
          }
      } catch (e) {
          showToast('An error occurred while clearing the list.', 'error');
      }
  }

  if (file_ids.length > 0) {
      loadFolderTree();
      document.getElementById('confirmShareBtn').addEventListener('click', confirmShare);
      document.getElementById('clearShareBtn').addEventListener('click', clearShareList);
  }
</script>
{% endblock %}
