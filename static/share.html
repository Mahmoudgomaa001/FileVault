<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Share Files - FileVault</title>
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="/static/fonts.css" />
  <link rel="stylesheet" href="/static/vendor/fontawesome/css/all.min.css" />

  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    :root {
      --primary:#3B82F6; --primary-dark:#2563EB; --secondary:#8B5CF6; --success:#10B981; --danger:#EF4444;
      --bg-primary:#0F172A; --bg-secondary:#1E293B; --bg-tertiary:#334155; --text-primary:#F8FAFC; --text-secondary:#CBD5E1; --text-muted:#64748B;
      --border:#334155; --shadow:rgba(0,0,0,0.5); --header-height:60px;
    }
    body { font-family:'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background:var(--bg-primary); color:var(--text-primary); min-height:100vh; }
    .container { max-width:800px; margin:0 auto; padding:1.5rem; }
    .card { background:var(--bg-secondary); border:1px solid var(--border); border-radius:.75rem; padding:1.5rem; margin-bottom:1.5rem; }
    h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    p { color: var(--text-secondary); margin-bottom: 1rem; }
    .btn { padding:.625rem 1rem; border-radius:.5rem; font-weight:600; cursor:pointer; transition:all .2s; border:none; display:inline-flex; align-items:center; justify-content:center; gap:.5rem; font-size:.875rem; text-decoration:none; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-secondary { background:var(--bg-tertiary); color:var(--text-primary); }
    .btn-danger { background:var(--danger); color:#fff; }
    #folderTree .folder-tree-item { padding:.5rem .75rem; border-radius:.375rem; cursor:pointer; -webkit-user-select:none; user-select:none; }
    #folderTree .folder-tree-item:hover { background:var(--bg-tertiary); }
    #folderTree .folder-tree-item.selected { background:var(--primary); color:white; font-weight:600; }
    .toast-container { position:fixed; top:1rem; right:1rem; z-index:3000; }
    .toast { background:var(--bg-secondary); border:1px solid var(--border); border-radius:.5rem; padding:.75rem; margin-bottom:.5rem; min-width:250px; box-shadow:0 4px 12px var(--shadow); }
    .toast.error { border-left:3px solid var(--danger); }
  </style>
</head>
<body>

<div class="container">
  <div class="card" id="mainContainer">
    <h1>Shared Files</h1>
    <p id="instructions">Loading...</p>
    <div id="fileList" style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;"></div>
    <div id="actions" style="display: none;">
        <p><b>Select destination folder:</b></p>
        <div id="folderTree" style="height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: .5rem; border-radius: .5rem; background: var(--bg-primary); margin-bottom: 1rem;"></div>
        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1rem;">
            <button class="btn btn-primary" id="localShareBtn" disabled><i class="fas fa-server"></i> Local Share</button>
            <button class="btn btn-secondary" id="onlineShareBtn" style="display: none;"><i class="fas fa-cloud"></i> Online Share</button>
            <button class="btn btn-danger" id="clearBtn"><i class="fas fa-trash"></i> Clear All</button>
        </div>
    </div>
    <div id="progressContainer" style="margin-top: 1rem;"></div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
  const DB_NAME = 'file-share-db';
  const STORE_NAME = 'shared-files';
  let sharedFiles = []; // To hold the retrieved File objects
  let appData = null;

  function showToast(message, type='info'){
      const container = document.getElementById('toastContainer'); if(!container) return;
      const toast = document.createElement('div'); toast.className = `toast ${type}`;
      toast.innerHTML = `<div class="toast-message">${message}</div>`;
      container.appendChild(toast);
      setTimeout(()=>{ toast.style.opacity='0'; setTimeout(()=>toast.remove(), 300); }, 3000);
  }

  function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = () => {
            if (!request.result.objectStoreNames.contains(STORE_NAME)) {
                request.result.createObjectStore(STORE_NAME, { autoIncrement: true });
            }
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
  }

  async function getStoredFiles() {
    const db = await openDB();
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const allFiles = await new Promise((resolve, reject) => {
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
    db.close();
    return allFiles;
  }

  function loadAppData() {
      const dataStr = localStorage.getItem('appData');
      if (!dataStr) return null;
      try {
          return JSON.parse(dataStr);
      } catch (e) {
          console.error("Failed to parse appData from localStorage", e);
          return null;
      }
  }

  function renderFolderTree(nodes, level = 0) {
      let html = '';
      for (const node of nodes) {
          html += `<div class="folder-tree-item" data-path="${node.path}" style="padding-left: ${level * 20 + 5}px;"><i class="fas fa-folder"></i> ${node.name}</div>`;
          if (node.children && node.children.length > 0) {
              html += renderFolderTree(node.children, level + 1);
          }
      }
      return html;
  }

  async function clearShareList() {
      if (!confirm('Are you sure you want to clear all shared files from your browser? This cannot be undone.')) return;
      try {
        const db = await openDB();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        store.clear();
        tx.oncomplete = () => {
            db.close();
            document.getElementById('mainContainer').innerHTML = '<h1>List Cleared</h1><p>The shared files have been removed from your browser. You can close this page.</p><a href="/" class="btn btn-primary">Back to App</a>';
        };
      } catch (e) {
          showToast('An error occurred while clearing the list.', 'error');
      }
  }

  function createProgressElement(filename, id){
      const div = document.createElement('div');
      div.className = 'progress-item';
      div.dataset.uploadId = id;
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
            <span>${filename}</span>
            <span class="progress-percent">0%</span>
        </div>
        <div style="height:4px; background:var(--bg-tertiary); border-radius:2px; overflow:hidden;">
            <div class="progress-fill" style="height:100%; background:var(--primary); border-radius:2px; width:0%; transition:width .25s ease;"></div>
        </div>
      `;
      return div;
  }
  function updateProgress(element, percent){
      if(!element) return;
      element.querySelector('.progress-fill').style.width = `${percent}%`;
      element.querySelector('.progress-percent').textContent = `${Math.round(percent)}%`;
  }

  function fileToBase64(file) {
      return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
      });
  }

  async function doShare(targetBaseUrl) {
      const selectedFolderEl = document.querySelector('#folderTree .selected');
      if (sharedFiles.length === 0 || !selectedFolderEl) {
          showToast('Please select files and a destination folder.', 'error');
          return;
      }
      const destination = selectedFolderEl.dataset.path;

      // Disable buttons and show progress
      document.querySelectorAll('#actions button').forEach(b => b.disabled = true);
      const progressContainer = document.getElementById('progressContainer');
      progressContainer.innerHTML = ''; // Clear previous progress bars
      const overallProgressEl = createProgressElement(`Preparing ${sharedFiles.length} files...`, 'overall');
      progressContainer.appendChild(overallProgressEl);
      updateProgress(overallProgressEl, 5); // Initial progress

      try {
        const b64Promises = sharedFiles.map(fileToBase64);
        const filesAsB64 = await Promise.all(b64Promises);
        updateProgress(overallProgressEl, 50); // Halfway done after encoding

        // Create a dynamic form
        const form = document.createElement('form');
        form.method = 'POST';
        // The action is now a full, absolute URL
        form.action = `${targetBaseUrl}/upload_b64`;
        form.style.display = 'none';

        // Add destination
        const destInput = document.createElement('input');
        destInput.type = 'hidden';
        destInput.name = 'dest';
        destInput.value = destination;
        form.appendChild(destInput);

        // Add the upload token
        const tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = 'upload_token';
        tokenInput.value = appData.upload_token;
        form.appendChild(tokenInput);

        // Add file names and data
        for (let i = 0; i < sharedFiles.length; i++) {
            const nameInput = document.createElement('input');
            nameInput.type = 'hidden';
            nameInput.name = 'filenames';
            nameInput.value = sharedFiles[i].name;
            form.appendChild(nameInput);

            const dataInput = document.createElement('input');
            dataInput.type = 'hidden';
            dataInput.name = 'files_b64';
            dataInput.value = filesAsB64[i];
            form.appendChild(dataInput);
        }

        document.body.appendChild(form);
        updateProgress(overallProgressEl, 95);

        // Clear IndexedDB before submitting the form
        const db = await openDB();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).clear();
        tx.oncomplete = () => {
            db.close();
            // Submit the form, which will cause a full-page navigation
            form.submit();
        };
        tx.onerror = () => {
            // If clearing fails, still try to submit the form
            db.close();
            console.error("Failed to clear IndexedDB, but proceeding with form submission.");
            form.submit();
        };

      } catch (e) {
          showToast('An error occurred while preparing the files for upload.', 'error');
          document.querySelectorAll('#actions button').forEach(b => b.disabled = false);
      }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const instructions = document.getElementById('instructions');
    appData = loadAppData();
    if (!appData) {
        instructions.innerHTML = 'Required data not found. Please <a href="/" style="color:var(--primary)">open the main application</a> at least once to sync settings before using the share feature.';
        return;
    }

    try {
      sharedFiles = await getStoredFiles();
      const fileListDiv = document.getElementById('fileList');
      const actionsDiv = document.getElementById('actions');

      if (sharedFiles.length > 0) {
        instructions.textContent = `You have ${sharedFiles.length} file(s) ready to share.`;
        fileListDiv.innerHTML = sharedFiles.map(file => `<div class="card" style="padding: 0.75rem;">${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</div>`).join('');
        actionsDiv.style.display = 'block';

        // Render folder tree
        const folderTreeDiv = document.getElementById('folderTree');
        folderTreeDiv.innerHTML = renderFolderTree(appData.folder_tree);
        document.querySelectorAll('#folderTree .folder-tree-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('#folderTree .folder-tree-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                document.getElementById('localShareBtn').disabled = false;
                // Also enable the online button if it exists
                if (document.getElementById('onlineShareBtn')) {
                    document.getElementById('onlineShareBtn').disabled = false;
                }
            });
        });

        // Setup buttons
        const localBtn = document.getElementById('localShareBtn');
        const onlineBtn = document.getElementById('onlineShareBtn');
        const clearBtn = document.getElementById('clearBtn');

        clearBtn.addEventListener('click', clearShareList);

        // Wire up Local Share button
        if (appData.local_base_url) {
            localBtn.addEventListener('click', () => doShare(appData.local_base_url));
        } else {
            localBtn.disabled = true;
        }

        // Wire up Online Share button only if the URL exists
        if (appData.online_base_url) {
            onlineBtn.style.display = 'inline-flex';
            onlineBtn.disabled = true; // Disabled until a folder is selected
            onlineBtn.addEventListener('click', () => doShare(appData.online_base_url));
        } else {
            onlineBtn.style.display = 'none';
        }

      } else {
        instructions.textContent = 'No pending files to share. You can close this page.';
      }
    } catch (error) {
      console.error('Error initializing share page:', error);
      instructions.textContent = 'Could not retrieve shared files. Please try sharing again.';
    }
  });

</script>
</body>
</html>
